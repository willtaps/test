    SUBROUTINE IB.ATM.LOG.ERROR( G$THIS )

    $INCLUDE I_COMMON
    $INCLUDE I_EQUATE
    $INCLUDE IB.BP I_IB.ATM.MSG.COMMON
    $INCLUDE IB.BP I_F.IB.PARAMETER.SB
    $INCLUDE JBC.h

    GOSUB INITIALISE

    GOSUB PROCESS

    RETURN

PROCESS:

    IF NOT(M.CONTINUE) THEN RETURN

    CONVERT FM TO "^" IN ETEXT
    CONVERT VM TO "~" IN ETEXT
    CONVERT SM TO "@" IN ETEXT

    YMSG = FMT(YPID,"10L"):FMT(G$THIS,"40L") : " " : ETEXT
    CMD = 'iblogger.sh ' : IB.LOG.LEVEL :' ../bnk.data/ib/logs IB "' :YMSG:'"'
    GOSUB SHELL.EXEC:

    RETURN

INITIALISE:

    YPORT.ID = SYSTEM(101)
    YPID = JBASEGetPidFromPort(YPORT.ID)

    M.CONTINUE = 1

    IF R.IB.PARAMETER.SB<IB.PARM.DEBUG> = "NO" THEN
        IF IB.LOG.LEVEL <> "ERROR" THEN
            M.CONTINUE = 0
        END
    END

    IF IB.LOG.LEVEL = "ERROR" THEN
        TXN.ERROR.TRACE<1,-1> = ETEXT
    END

    RETURN

SHELL.EXEC:

    EXECUTE CHARX(255):"s":CMD CAPTURING MSG RETURNING YERR

    RETURN

END
